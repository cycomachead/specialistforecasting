<project name="AppStore Build" default="systemProperties" basedir=".">
    <property file="user.properties"/>
    <property file="build.properties"/>
	<property file="default.properties"/>
    

	<import file="build-apex.xml" />	

	<target name="systemProperties">
		<echo message="Java Runtime Environment version: ${java.version}"/>
	    <echo message="Java Runtime Environment vendor: ${java.vendor}"/>
	    <echo message="Java Runtime Environment vendor URL: ${java.vendor.url}"/>
	    <echo message="Java installation directory: ${java.home}"/>
	    <echo message="Java Virtual Machine specification version: ${java.vm.specification.version}"/>
	    <echo message="Java Virtual Machine specification vendor: ${java.vm.specification.vendor}"/>
	    <echo message="Java Virtual Machine specification name: ${java.vm.specification.name}"/>
	    <echo message="Java Virtual Machine implementation version: ${java.vm.version}"/>
	    <echo message="Java Virtual Machine implementation vendor: ${java.vm.vendor}"/>
	    <echo message="Java Virtual Machine implementation name: ${java.vm.name}"/>
	    <echo message="Java Runtime Environment specification version: ${java.specification.version}"/>
	    <echo message="Java Runtime Environment specification vendor: ${java.specification.vendor}"/>
	    <echo message="Java Runtime Environment specification name: ${java.specification.name}"/>
	    <echo message="Java class format version number: ${java.class.version}"/>
	    <echo message="Java class path: ${java.class.path}"/>
	    <echo message="List of paths to search when loading libraries: ${java.library.path}"/>
	    <echo message="Path of extension directory or directories: ${java.ext.dirs}"/>
	    <echo message="Default temp file path: ${java.io.tmpdir}"/>
	    <echo message="Operating system name: ${os.name}"/>
	    <echo message="Operating system architecture: ${os.arch}"/>
	    <echo message="Operating system version: ${os.version}"/>
	</target>	
	
	<target name="appendProp">
		<exec executable="hostname" outputproperty="host.name"/>
		<concat destfile="license.properties">devhome.dir=${devhome.dir}<![CDATA[
]]>endpoint=http://${host.name}:${http_port}<![CDATA[
]]>base.release=${base.release}<![CDATA[
]]>
		</concat>
		<concat destfile="license.properties" append="true" fixlastline="yes">
			<filelist dir="${basedir}" files="autobuild.license.properties"/>
		</concat>
        <concat destfile="store.properties">devhome.dir=${devhome.dir}<![CDATA[
]]>endpoint=http://${host.name}:${http_port}<![CDATA[
]]>store.release=${store.release}<![CDATA[
]]>java.home=${JAVA_HOME}<![CDATA[
]]>
        </concat>
        <concat destfile="store.properties" append="true" fixlastline="yes">
            <filelist dir="${basedir}" files="autobuild.store.properties"/>
        </concat>		
	</target>

	<target name="copyBuildProperties" depends="appendProp">
		<copy file="build.properties" todir="${baseapp.home}/build" overwrite="true"/>
		<copy file="license.properties" tofile="${license.home}/build/user.properties" overwrite="true"/>
        <move file="${storetools.home}/build/build.properties" tofile="${storetools.home}/build/build.properties.save" overwrite="true" preservelastmodified="true"/>
        <copy file="store.properties" tofile="${storetools.home}/build/build.properties" overwrite="true"/>
	</target>
	
	<target name="refreshRemoteSfmDatabaseForce" description="wrapper of base refreshRemoteSfmDatabaseForce">
		<echo message="dbserver is ${dbserver}"/>
		<echo message="instanceId is ${instanceId}"/>
		<echo message="release is ${release}"/>
		<echo message="changelist is ${changelist}"/>
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">			
			<arg line="ant refreshRemoteSfmDatabaseForce -Ddbserver=${dbserver} -DinstanceId=${instanceId} -Drelease=${release} -Dchangelist=${changelist} -Dautobuild.isPartialRun=${autobuild.isPartialRun}"/>
		</exec>
	</target>
	
	<target name="refreshRemoteSfmDatabase" description="wrapper of base refreshRemoteSfmDatabase">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
			<arg line="ant refreshRemoteSfmDatabase -Ddbserver=${dbserver} -DinstanceId=${instanceId} -Drelease=${release} -Dchangelist=${changelist} -Dautobuild.isPartialRun=${autobuild.isPartialRun}"/>
		</exec>
	</target>
	
	<target name="refreshRemoteSfmDatabaseAggressive" description="wrapper of base refreshRemoteSfmDatabaseAggressive">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
			<arg line="ant refreshRemoteSfmDatabaseAggressive -Ddbserver=${dbserver} -DinstanceId=${instanceId} -Drelease=${release} -Dchangelist=${changelist} -Dautobuild.isPartialRun=${autobuild.isPartialRun}"/>
		</exec>
	</target>
	
	<target name="distclean" depends="copyBuildProperties" description="wrapper of base distclean">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
			<arg line="ant distclean"/>
		</exec>	
	</target>
	
	<target name="autobuildsetup" description="wrapper of base autobuildsetup">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
			<arg line="ant autobuildsetup"/>
		</exec>
	</target>
	
	<target name="cleanupAutobuildResources" description="wrapper of base cleanupAutobuildResources">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
			<arg line="ant cleanupAutobuildResources"/>
		</exec>
	</target>
	
	<target name="compileBaseApp" depends="copyBuildProperties, stopApp" description="compile the base sfdc app">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true" resultproperty="result.compiled">
			<arg line="ant all plsql"/>
		</exec>		
	</target>	
	
	<target name="checkAppStarted">
		<waitfor maxwait="5" maxwaitunit="minute" checkevery="500" timeoutproperty="start.timedout">
			<http url="${endpoint}/secur/login_page.jsp"/>
		</waitfor>
		<condition property="app.started">
			<not>
				<isset property="start.timedout"/>
			</not>
		</condition> 				
	</target>
	
	<target name="checkAppStopped">
		<waitfor maxwait="5" maxwaitunit="second" checkevery="500" timeoutproperty="stop.timedout">
			<not>
				<http url="${endpoint}/secur/login_page.jsp"/>	
			</not>
		</waitfor>
		<condition property="app.stopped">
			<not>
				<istrue value="${stop.timedout}"/>
			</not>
		</condition>				
	</target>		
	
	<target name="startApp" depends="checkAppStopped" if="app.stopped">		
		<exec executable="perl" dir="${baseapp.home}/build" spawn="true">
			<arg line="ant run"/>
		</exec>
		<echo message="Starting the app, please wait..."/>
		<waitfor maxwait="5" maxwaitunit="minute" checkevery="500" timeoutproperty="start.timedout">
			<http url="${endpoint}/secur/login_page.jsp"/>
		</waitfor>
		<fail message="Fail to start up base app." if="start.timedout"/>			
	</target>
	
	<target name="stopApp" depends="checkAppStopped" unless="app.stopped">
		<exec executable="${JAVA_HOME}/bin/jps" output="/tmp/javaPid" failonerror="true">
			<arg line="-l"/>
		</exec>
		<exec executable="awk" outputproperty="pid" failonerror="true">
			<arg line="'/com.caucho.server.resin.Resin/ {print $1}' /tmp/javaPid" />
		</exec>
		<echo message="${pid}"/>
		<exec executable="kill" failonerror="true">
			<arg line="${pid}"/>
		</exec>
		<delete file="/tmp/javaPid"/>
		<property name="stop.timedout" value="false"/>
		<sleep seconds="2"/>		                		                
	</target>
	
	<target name="deployDE" depends="startApp">
		<exec executable="perl" dir="${license.home}/build" failonerror="true">
			<arg line="ant -verbose deployDE -Ddevhome.dir=${devhome.dir} -Dendpoint=${endpoint} -Dtools.dir=${tools.home} -Dbase.release=${base.release}"/>
		</exec>	
	</target>
	
	<target name="insertDefinitionsIntoProv" depends="startApp">
		<exec executable="perl" dir="${license.home}/build" failonerror="true">
			<arg line="ant -verbose insertDefinitionsIntoProv -Ddevhome.dir=${devhome.dir} -Dendpoint=${endpoint} -Dtools.dir=${tools.home} -Dbase.release=${base.release}"/>
		</exec>
	</target>
	
	<target name="runProvisioningDeployTest" depends="stopApp">
		<sequential>			
			<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">				
				<arg line="ant appstoretest -Dftest.testLabels=provisioning"/>
			</exec>
		</sequential>
	</target>
	
	<target name="insertAllIntoSfdc" depends="startApp">
		<exec executable="hostname" outputproperty="host.name"/>
		<exec executable="perl" dir="${license.home}/build" failonerror="true">
			<arg line="ant insertAllIntoSfdc -Ddevhome.dir=${devhome.dir} -Dendpoint=http://${host.name}:${http_port} -Dtools.dir=${tools.home} -Dbase.release=${base.release}"/>
		</exec>
	</target>
	<target name="deploySFDC" depends="startApp">
		<exec executable="hostname" outputproperty="host.name"/>
		<exec executable="perl" dir="${license.home}/build" failonerror="true">
			<arg line="ant deploySFDC -Ddevhome.dir=${devhome.dir} -Dendpoint=http://${host.name}:${http_port} -Dtools.dir=${tools.home} -Dbase.release=${base.release}"/>
		</exec>
	</target>
	<target name="updateLicenseMapEndVersions" depends="startApp">
		<exec executable="hostname" outputproperty="host.name"/>
		<exec executable="perl" dir="${license.home}/build" failonerror="true">
			<arg line="ant updateLicenseMapEndVersions -Ddevhome.dir=${devhome.dir} -Dendpoint=http://${host.name}:${http_port} -Dtools.dir=${tools.home} -Dbase.release=${base.release}"/>
		</exec>
	</target>
	
	<target name="mapNewLicenseVersions" depends="startApp">
		<exec executable="hostname" outputproperty="host.name"/>
		<exec executable="perl" dir="${license.home}/build" failonerror="true">
			<arg line="ant mapNewLicenseVersions -Ddevhome.dir=${devhome.dir} -Dendpoint=http://${host.name}:${http_port} -Dtools.dir=${tools.home} -Dbase.release=${base.release}"/>
		</exec>
	</target>
	
	<target name="runInsertDefinitions" depends="insertDefinitionsIntoProv">
		<echo message="Running the second time of insertDefinitionsIntoProv"/>
		<antcall target="insertDefinitionsIntoProv"/>
	</target>
	
	<target name="runInsertAll" depends="insertAllIntoSfdc">
		<echo message="Runing the second time of insertAllIntoSfdc"/>
		<antcall target="insertAllIntoSfdc"/>
	</target>
	
	<target name="deployProvisioning" description="deploy the provisioning to base app">
		<sequential>
			<antcall target="deployDE"/>
			<antcall target="runInsertDefinitions"/>
			<antcall target="runProvisioningDeployTest"/>
			<antcall target="runInsertAll"/>
			<antcall target="deploySFDC"/>
			<antcall target="updateLicenseMapEndVersions"/>
			<antcall target="mapNewLicenseVersions"/>
			<antcall target="stopApp"/>
		</sequential>
	</target>
	
	<target name="appstoretest" description="run appstore ftest">
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
			<arg line="ant appstoretest -Dftest.testLabels=provisioning"/>
		</exec>
	</target>
	
    <target name="deployBasebizDE" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployBasebizDE"/>
        </exec>
    </target>

    <target name="deployBillingDE" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployBillingDE"/>
        </exec>
    </target>

    <target name="deployQuoteDE" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployQuoteDE"/>
        </exec>
    </target>

    <target name="deployOmDE" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployOmDE"/>
        </exec>
    </target>

    <target name="deployBasebizSFDC" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployBasebizSFDC"/>
        </exec>
    </target>

    <target name="deployBillingSFDC" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployBillingSFDC"/>
        </exec>
    </target>

    <target name="deployQuoteSFDC" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployQuoteSFDC"/>
        </exec>
    </target>

    <target name="deployOmSFDC" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose deployOmSFDC"/>
        </exec>
    </target>

    <target name="installBaseBizDE" depends="stopApp">
        <exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=basebiztobilling"/>
        </exec>
		<exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=basebiztoquote"/>
        </exec>
        <exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=basebiztoom"/>
        </exec>
        <exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=basebiztosfdc"/>
        </exec>	
    </target>

    <target name="installBillingDE" depends="stopApp">
        <exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=billingtosfdc"/>
        </exec>
    </target>

    <target name="installQuoteDE" depends="stopApp">
        <exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=quotetosfdc"/>
        </exec>
    </target>

    <target name="installOmDE" depends="stopApp">
        <exec executable="perl" dir="${baseapp.home}/build" failonerror="true">
            <arg line="ant appstoretest -Dftest.testLabels=omtosfdc"/>
        </exec>
    </target>

    <target name="runBasebizDeTests" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runBasebizDeTests"/>
        </exec>
    </target>

    <target name="runBillingDeTests" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runBillingDeTests"/>
        </exec>
    </target>
	
	<target name="runQuoteDeTests" depends="startApp">
	    <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runQuoteDeTests"/>
        </exec>
    </target>

    <target name="runBasebizOrg62Test" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runBasebizOrg62Test"/>
        </exec>
    </target>

    <target name="runBillingOrg62Test" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runBillingOrg62Test"/>
        </exec>
    </target>

    <target name="runQuoteOrg62Test" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runQuoteOrg62Test"/>
        </exec>
    </target>

    <target name="runOmOrg62Test" depends="startApp">
        <exec executable="perl" dir="${storetools.home}/build" failonerror="true">
            <arg line="ant -verbose runOmOrg62Test"/>
        </exec>
    </target>

    <target name="deployAppstore" description="deploy appstore to base app">
        <sequential>
                <antcall target="deployBasebizDE"/>
                <antcall target="runBasebizDeTests"/>
                <antcall target="installBaseBizDE"/>
                <antcall target="deployBillingQuoteOmDE"/>
                <antcall target="runBillingQuoteDeTests"/>
                <antcall target="installBillingDE"/>
                <antcall target="installQuoteDE"/>
                <antcall target="installOmDE"/>
                <antcall target="deployBasebizSFDC"/>
                <antcall target="deployBillingSFDC"/>
                <antcall target="deployQuoteSFDC"/>
                <antcall target="deployOmSFDC"/>
        </sequential>
    </target>

    <target name="deployBillingQuoteOmDE" description="deploy the basebiz to base app">
        <parallel>
            <antcall target="deployBillingDE"/>
            <antcall target="deployQuoteDE"/>
            <antcall target="deployOmDE"/>
        </parallel>
    </target>

    <target name="runBillingQuoteDeTests" description="deploy the basebiz to base app">
        <parallel>
            <antcall target="runBillingDeTests"/>
            <antcall target="runQuoteDeTests"/>
        </parallel>
    </target>

    <target name="runApexTest" description="Runs Appstore Apex tests">
        <parallel>
            <antcall target="runBasebizOrg62Test"/>
            <antcall target="runBillingOrg62Test"/>
            <antcall target="runQuoteOrg62Test"/>
            <antcall target="runOmOrg62Test"/>
        </parallel>
    </target>
	
    <target name="restoreBuildProperties">
        <move file="${storetools.home}/build/build.properties.save" tofile="${storetools.home}/build/build.properties" overwrite="true" preservelastmodified="true"/>
    </target>
</project>
